name: build_push

on:
  workflow_call:
    inputs:
      APPLICATION:
        description: 'Application for which to build container image'
        required: true
        type: string
      VERSION:
        description: 'Version to include in tag'
        required: true
        type: string
      PUSH_TO_PUBLIC:
        description: 'Push image to public registry'
        required: false
        type: boolean
        default: false
      PUSH_TO_PRIVATE:
        description: 'Push image to private registry'
        required: false
        type: boolean
        default: true
      WF_OWNER:
        description: 'Registry owner'
        required: true
        type: string
      WF_REGISTRY_PRIVATE:
        description: 'Private registry URI:PORT'
        required: true
        type: string
      WF_REGISTRY_PRIVATE_PULL:
        description: 'Private registry URI:PULL_PORT'
        required: true
        type: string
      WF_REGISTRY_PUBLIC:
        description: 'Public registry URI'
        required: true
        type: string
    secrets:
      WF_REGISTRY_PRIVATE_USER:
        required: true
      WF_REGISTRY_PRIVATE_PASSWD:
        required: true
      WF_REGISTRY_PUBLIC_USER:
        required: true
      WF_REGISTRY_PUBLIC_PASSWD:
        required: true
      

jobs:

  ## PUBLIC ##

  build-image-push-public:
    strategy:
      matrix:
        platform:
          - amd64
          - arm64
        include:
          - platform: amd64
            runner: gha-runner-scale-set-amd64
          - platform: arm64
            runner: gha-runner-scale-set-arm64
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.PUSH_TO_PUBLIC == true }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: v6Org01/.github/actions/setup-buildx-privateRegistry@main
        with:
          REGISTRY: ${{ inputs.WF_REGISTRY_PRIVATE_PULL }}
          REGISTRY_USER: ${{ secrets.WF_REGISTRY_PRIVATE_USER }}
          REGISTRY_PASSWD: "${{ secrets.WF_REGISTRY_PRIVATE_PASSWD }}"
      - name: Login to public # to push
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.WF_REGISTRY_PUBLIC }}
          username: ${{ secrets.WF_REGISTRY_PUBLIC_USER }}
          password: ${{ secrets.WF_REGISTRY_PUBLIC_PASSWD }}
      - name: Build and push to public
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/${{ matrix.platform }}
          file: src/docker/Dockerfile
          push: true
          cache-from: type=gha,scope=build-${{ inputs.APPLICATION }}-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=build-${{ inputs.APPLICATION }}-${{ matrix.platform }}
          provenance: false
          build-args: |
            REGISTRY=${{ inputs.WF_REGISTRY_PRIVATE_PULL }}
          tags: |
            "${{ inputs.WF_REGISTRY_PUBLIC }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}-${{ matrix.platform }}"

  build-merge-public:
    runs-on: gha-runner-scale-set-arm64
    needs: build-image-push-public
    steps:
      - name: Set up Docker Buildx
        uses: v6Org01/.github/actions/setup-buildx-privateRegistry@main
        with:
          REGISTRY: ${{ inputs.WF_REGISTRY_PRIVATE_PULL }}
          REGISTRY_USER: ${{ secrets.WF_REGISTRY_PRIVATE_USER }}
          REGISTRY_PASSWD: "${{ secrets.WF_REGISTRY_PRIVATE_PASSWD }}"
      - name: Login to public registry
        uses: docker/login-action@v3
        with:
          registry: ${{ inputs.WF_REGISTRY_PUBLIC }}
          username: ${{ secrets.WF_REGISTRY_PUBLIC_USER }}
          password: ${{ secrets.WF_REGISTRY_PUBLIC_PASSWD }}
      - name: Create manifest list and push
        run: |
          docker buildx imagetools create -t "${{ inputs.WF_REGISTRY_PUBLIC }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}" \
            "${{ inputs.WF_REGISTRY_PUBLIC }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}-amd64" \
            "${{ inputs.WF_REGISTRY_PUBLIC }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}-arm64"
      - name: Inspect image
        run: |
          docker buildx imagetools inspect "${{ inputs.WF_REGISTRY_PUBLIC }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}"

  ## PRIVATE ##

  build-image-push-private:
    strategy:
      matrix:
        platform:
          - amd64
          - arm64
        include:
          - platform: amd64
            runner: gha-runner-scale-set-amd64
          - platform: arm64
            runner: gha-runner-scale-set-arm64
    runs-on: ${{ matrix.runner }}
    if: ${{ inputs.PUSH_TO_PRIVATE == true }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: v6Org01/.github/actions/setup-buildx-privateRegistry@main
        with:
          REGISTRY: ${{ inputs.WF_REGISTRY_PRIVATE_PULL }}
          REGISTRY_USER: ${{ secrets.WF_REGISTRY_PRIVATE_USER }}
          REGISTRY_PASSWD: "${{ secrets.WF_REGISTRY_PRIVATE_PASSWD }}"
      - name: Build and push to private
        id: build
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/${{ matrix.platform }}
          file: src/docker/Dockerfile
          push: true
          cache-from: type=gha,scope=build-${{ inputs.APPLICATION }}-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=build-${{ inputs.APPLICATION }}-${{ matrix.platform }}
          provenance: false
          build-args: |
            REGISTRY=${{ inputs.WF_REGISTRY_PRIVATE_PULL }}
          tags: |
            "${{ inputs.WF_REGISTRY_PRIVATE }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}-${{ matrix.platform }}"

  build-merge-private:
    runs-on: gha-runner-scale-set-arm64
    needs: build-image-push-private
    steps:
      - name: Set up Docker Buildx
        uses: v6Org01/.github/actions/setup-buildx-privateRegistry@main
        with:
          REGISTRY: ${{ inputs.WF_REGISTRY_PRIVATE_PULL }}
          REGISTRY_USER: ${{ secrets.WF_REGISTRY_PRIVATE_USER }}
          REGISTRY_PASSWD: "${{ secrets.WF_REGISTRY_PRIVATE_PASSWD }}"
      - name: Create manifest list and push
        run: |
          docker buildx imagetools create -t "${{ inputs.WF_REGISTRY_PRIVATE }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}" \
            "${{ inputs.WF_REGISTRY_PRIVATE }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}-amd64" \
            "${{ inputs.WF_REGISTRY_PRIVATE }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}-arm64"
      - name: Inspect image
        run: |
          docker buildx imagetools inspect "${{ inputs.WF_REGISTRY_PRIVATE }}/${{ inputs.WF_OWNER }}/arc-${{ inputs.APPLICATION }}:${{ inputs.VERSION }}"
